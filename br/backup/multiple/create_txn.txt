# 123123
mysql -h 172.30.14.11 -P 3307 -u root -p

set executor default_replica=3;

show tenants;

// 事务 普通表
#  80039	T_50003_T2_part_60074[80039]  STORE_REGION
CREATE TABLE t2 (
	ID int auto_increment,
	NAME varchar(1024) not null, 
	primary key(ID)
) engine = TXN_LSM REPLICA=3;


INSERT INTO t2 values (1, '123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890');
INSERT INTO t2 values (2, '123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890');

INSERT INTO t2 values (3, '123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890');
INSERT INTO t2 values (4, '123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890');

INSERT INTO t2 values (5, '123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890');
INSERT INTO t2 values (6, '123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890');

update t2 set NAME='1-1-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=1;
update t2 set NAME='2-2-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=2;
update t2 set NAME='3-3-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=3;
update t2 set NAME='4-4-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=4;
update t2 set NAME='5-5-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=5;
update t2 set NAME='6-6-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=6;


update t2 set NAME='1-1-1-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=1;
update t2 set NAME='2-2-2-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=2;
update t2 set NAME='3-3-3-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=3;
update t2 set NAME='4-4-4-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=4;
update t2 set NAME='5-5-5-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=5;
update t2 set NAME='6-6-6-123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890' where id=6;


INSERT INTO t2 values (7, '123456');

select * from T2;

--------------------------------------------------------------------------------------------------------------
# 事务 文档索引 OK 
# 80040	T_50003_T3_part_60076[80040]                   STORE_REGION
# 80041	I_50003_T3.TEXT_INDEX1_part_60079[80041]       DOCUMENT_REGION
# 80042	I_50003_T3.TEXT_INDEX2_part_60080[80042]       DOCUMENT_REGION
create table T3( id bigint not null, author varchar(32),write_time date,text_id1 bigint not null,text_id2 bigint not null, novel varchar(1024) not null,description varchar(255) not null,primary key(id),
index text_index1 TEXT(text_id1, novel) parameters(text_fields='{"novel": {"tokenizer": {"type": "simple"}}}'),
index text_index2 TEXT(text_id2, description) parameters(text_fields='{"description": {"tokenizer": {"type": "stem"}}}'));

insert into T3 values 
(1, 'libai', '1999-12-01', 10, 1, 'hello', 'dingo'),
(2, 'libai', '2010-11-11', 50, 2, 'hello test', 'dingo test'),
(3, 'dufu', '2020-05-05', 100, 3, 'hello beijing', 'dingo fs'),
(4, 'libai', '2024-09-11', 200, 4, 'hello', 'dingo'),
(5, 'libai', '1949-10-01', 500, 5, 'yellow', 'mango');



---------------------------------------------------------------------------
# 未验证
create table dis024(id bigint not null, author varchar(32), write_time date, text_id bigint not null, novel varchar(1024) not null, description varchar(255) not null,
index text_index TEXT(text_id, novel) parameters(text_fields='{"novel":{"tokenizer": {"type": "simple"}}}'));


insert into dis024 values (1,'aa','2020-01-01',1,'hello','dingo');

select text_id,novel,TEXT_INDEX$RANK_BM25 bm25 from text_search(dis024, text_index, 'novel:hello',10);

select text_id1,novel,TEXT_INDEX1$RANK_BM25 from text_search(dis456, text_index1, 'novel:hello', 5);

select text_id2,description,TEXT_INDEX2$RANK_BM25 from text_search(dis456, text_index2, 'description:dingo', 5);



-----------------------------------------------------------------------------------------------------------
# 事务向量表
# 80043	T_50003_T4_part_60082[80043]                STORE_REGION
# 80044	I_50003_T4.FEATURE1_INDEX_part_60084[80044] INDEX_REGION
CREATE TABLE IF NOT EXISTS T4(
    ID INT AUTO_INCREMENT NOT NULL,
    NAME VARCHAR(32) NOT NULL COMMENT 'username',
    FEATURE1 FLOAT ARRAY NOT NULL, 
    PRIMARY KEY(ID), 
    FEATURE1_ID BIGINT NOT NULL,
    INDEX FEATURE1_INDEX VECTOR(FEATURE1_ID, FEATURE1) ENGINE=TXN_LSM PARTITION BY HASH PARTITIONS=1 REPLICA=3 PARAMETERS(type=flat, metricType=L2, dimension=2)
) ENGINE=TXN_LSM; 



insert into T4 values(1, 'zhangsan', array[0.19151945412158966, 0.6221087574958801], 1);
insert into T4 values(2, 'lisi', array[0.1915194232323, 0.232323], 2);
insert into T4 values(3, 'wangwu', array[0.343434, 0.343434], 3);


非事务 命令行创建 
-----------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------
# 创建普通表
# 80087	T_2_table_part_60170[80087]	1-1	STORE_REGION
sh create_table.sh

#!/bin/bash

cd ../build/bin/
./dingodb_client --method=CreateTable --name=table  --replica=3


sh add_table.sh

#!/bin/bash

cd ../build/bin/
./dingodb_client  --method=KvBatchPut --region_id=80087 --prefix=77000000000000eb0a --count=1000 --timeout_ms=1000000 --log_each_request=false


--------------------------------------------------------------------------------------------------------------------------------
# 创建向量表
# 80088	I_2_flat_part_60172[80088]	1-1	INDEX_REGION
sh create_vector_flat.sh

#!/bin/bash
cd ../build/bin/
./dingodb_client --method=CreateIndex --name=flat --vector_index_type=flat --dimension=8  --replica=3


sh  add_vector_flat.sh 
#!/bin/bash

cd ../build/bin/
./dingodb_client  --method=VectorAddBatch --region_id=80088 --dimension=8 --count=10000  --step_count=1000 --start_id=1 --timeout_ms=1000000 --log_each_request=false --vector_index_add_cost_file="./flat-10000.txt"

------------------------------------------------------------------------------------------------------------------------------------
# 创建文档表
#80089	I_2_document_part_60174[80089]	1-1	DOCUMENT_REGION

sh create_document.sh 
#!/bin/bash
cd ../build/bin/
./dingodb_client --method=CreateDocumentIndex --name=document  --replica=3

sh  add_document.sh 
#!/bin/bash
cd ../build/bin/
./dingodb_client  --method=DocumentAdd --region_id=80089 --document_id=1 --document_text1="hello world" --document_text2="hello world" --timeout_ms=1000000 --log_each_request=false
./dingodb_client  --method=DocumentAdd --region_id=80089 --document_id=2 --document_text1="hello world" --document_text2="hello world" --timeout_ms=1000000 --log_each_request=false
./dingodb_client  --method=DocumentAdd --region_id=80089 --document_id=3 --document_text1="hello world" --document_text2="hello world" --timeout_ms=1000000 --log_each_request=false

--------------------------------------------------------
# 推进解决锁的时间戳
mysql> admin back_up_time_point '2025-01-10 15:40:00';
+--------+-------------------+
| STATUS | SAFE_POINT        |
+--------+-------------------+
| FINISH | 41598792499200001 |
+--------+-------------------+
1 row in set (0.13 sec)

mysql> 


------------------------------------------------------------------
#创建租户
create tenant jarvex;

# 查看租户
show tenants;

# 修改 executor.yaml配置信息
cp -a executor.yaml executor-jarvex.yaml
vim /home/server/work/dingo/conf/executor-jarvex.yaml

cluster:
  ¦ name: dingo
exchange:
  ¦ host: 172.30.14.11
  ¦ port: 8766  # 原 8765 -> 8766
server:
  ¦ coordinators: 172.30.14.11:32001,172.30.14.11:32002,172.30.14.11:32003
  ¦ user: user
  ¦ keyring: keyring
  ¦ resourceTag: 1
  ¦ mysqlPort: 3308  # 3307 -> 3308

# 修改 start-executor.sh 脚本
cp -a  start-executor.sh start-executor-jarvex.sh

vim start-executor-jarvex.sh
nohup java ${JAVA_OPTS} \
     -Dlogback.configurationFile=file:${ROOT}/conf/logback-executor.xml \
     -classpath ${JAR_PATH}:${NET_JAR_PATH}:${LOCAL_STORE_JAR_PATH}  \
     io.dingodb.server.executor.Starter \
     --config ${ROOT}/conf/executor-jarvex.yaml \
     --tenant 1001 \ ## 加上这一句  jarvex 的租户ID
     > ${ROOT}/log/executor.out &


# mysql 连接
# 密码 : 123123
mysql -h 172.30.14.11 -P 3308 -u root -p

set executor default_replica=1;

mysql> show tenants;
+-----------+-------------+---------------------+---------------------+-----------+---------+
| TENANT_ID | TENANT_NAME | CREATED_TIME        | UPDATED_TIME        | IS_DELETE | REMARKS |
+-----------+-------------+---------------------+---------------------+-----------+---------+
| 1001      | jarvex      | 2025-01-06 17:36:02 | 2025-01-06 17:36:02 | false     | NULL    |
+-----------+-------------+---------------------+---------------------+-----------+---------+
1 row in set (0.02 sec)

mysql> admin back_up_time_point '2025-01-10 15:40:00';
+--------+-------------------+
| STATUS | SAFE_POINT        |
+--------+-------------------+
| FINISH | 41598792499200001 |
+--------+-------------------+
1 row in set (0.13 sec)

mysql> 


